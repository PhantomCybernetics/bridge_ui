<%- include('partial/header.html', { extraLinks: [ '<a href="#" id="helpLink">?</a>' ] }); %>

<h1 id="robot_name">Waiting for Connection...</h1>
<div class="cleaner"></div>
<div id="robot_info">Contacting <%= id_robot %>...</div><div id="socketio_status"></div>
<div id="robot_wifi_info" class="offline">
    <span id="robot_wifi_stats">// Waiting for network...</span>
    <button id="trigger_wifi_scan" title="#trigger_wifi_scan">scan</button>
</div>
<div class="cleaner"></div>
<br>
<!-- <div id="robot_stats" style="display:none"></div> -->

<div id="menubar">

    <div id="topic_controls">
        <h3 id="topics_heading">Topics</h3>
        <select id="msg_type_filter">
            <option value="">-- All message types --</option>
        </select>
        <div id="topic_list"></div>
    </div>

    <div id="service_controls">
        <h3 id="services_heading">Services</h3>
        <div id="service_list"></div>
    </div>

    <div id="camera_controls">
        <h3 id="cameras_heading">Cameras</h3>
        <div id="cameras_list"></div>
    </div>

    <div id="docker_controls">
        <h3 id="docker_heading">Docker</h3>
        <div id="docker_list"></div>
    </div>

    <div id="introspection_state" class="inactive"></div>

    <div class="cleaner"></div>

</div>

<div class="grid-stack" id="grid-stack"></div>

<!-- <div id="monitors" style="display:none"></div> -->

<%- include('partial/keyboard.html'); %>
<%- include('partial/gamepad.html'); %>

<div id="mapping-confirmation"></div>
<div id="msg_type-dialog"></div>

<script type="module">

    import { PhntmBridgeClient } from '/static/client.js';
    import { GamepadController } from '/static/gamepad.js';
    import { KeyboardController } from '/static/keyboard.js';
    import { PanelUI } from '/static/panel-ui.js';
    import { JoyDriver, TwistMecanumDriver } from '/static/gamepad-drivers.js';

    $(document).ready(function() {

        let robot = new PhntmBridgeClient({

            socket_url: '<%= bridge_socket_url %>',
            socket_path: '/app/socket.io/',
            socket_auto_connect: false,
            app_id: '<%= app_id %>',
            app_key: '<%= app_key%>',
            id_robot: '<%= id_robot %>',
            msg_types_src: '/static/msg_types.json',
            ice_servers: [{
                    urls:[
                        'stun:stun1.l.google.com:19302',
                        // 'stun:stun1.voiceeclipse.net:3478',
                        'stun:stun2.l.google.com:19302',
                        'stun:stun3.l.google.com:19302',
                        'stun:stun4.l.google.com:19302',
                        "stun:stun.l.google.com:19302",
                        // "turn:turn.phntm.io:3478",
                        // "turn:turn.phntm.io:5349"
                    ],
                    // username: 'robopass',
                    // credential: 'robopass'
                }]
        });

        let gamepad = new GamepadController(robot); // creates write channels when gamepad is connected
        gamepad.add_driver('Joy', 'sensor_msgs/msg/Joy (forward)', 'sensor_msgs/msg/Joy', JoyDriver);
        gamepad.add_driver('Twist', 'geometry_msgs/msg/Twist', 'geometry_msgs/msg/Twist', TwistMecanumDriver);
        gamepad.add_driver('TwistStamped', 'geometry_msgs/msg/TwistStamped', 'geometry_msgs/msg/TwistStamped', TwistMecanumDriver);

        let kb = new KeyboardController(robot); // creates write channels when enabled
        kb.add_driver('Joy', 'sensor_msgs/msg/Joy', 'sensor_msgs/msg/Joy', JoyDriver);
        kb.add_driver('Twist', 'geometry_msgs/msg/Twist', 'geometry_msgs/msg/Twist', TwistMecanumDriver);
        kb.add_driver('TwistStamped', 'geometry_msgs/msg/TwistStamped', 'geometry_msgs/msg/TwistStamped', TwistMecanumDriver);

        let panel_ui = new PanelUI(robot, 119, gamepad);

        //init panel setup from url
        //also subscribes to topics and cameras required by panel widgets
        panel_ui.panels_from_url_hash(window.location.hash);

        robot.on('error', (err, msg)=>{
            // $('#robot_info').html('<span class="error">'+msg+'</spam>');
        })

        //robot connected via Socket.io
        robot.on('online', (state)=>{
            if (state)
                console.info('(Socket.io) Robot connected to Bridge server');
            else
                console.info('(Socket.io) Robot disconnected from Bridge server');
        });

        // introspection running in the robot
        robot.on('introspection',  (state) => {
            if (state)
                console.info('(Socket.io) Robot introspection running');
            else
                console.info('(Socket.io) Robot introspection stopped');
        });

        // robot's state changed
        robot.on('update', ()=>{
            console.info('(Socket.io) robot updated');
        });

        robot.on('nodes', (nodes)=>{
            console.warn('(Socket.io) got nodes:', nodes);
        });

        // subscribes to /robot_description
        // robot.on('/robot_description', (xml_str)=>{
        //     console.warn('/robot_description:', xml_str)
        // });

        // robot.on('/rosout', (log_line)=>{
        //     console.log('/rosout: ', log_line);
        // });

        // subscribes to /iw_status
        // robot.on('/iw_status', (msg)=>{
        //     console.log('Got /iw_status msg', msg);
        // });

        // subscribes to /battery
        // robot.on('/battery', (msg)=>{

        // });

        // robot.on('media_stream', (stream)=>{
        //     console.log('Got a stream', stream);
        // });

        // robot.on('/picam2/base/soc/i2c0mux/i2c@1/imx708@1a', (stream)=>{
        //      console.log('Got picamera stream', stream);
        // });

        // robot.on('/htop', (msg)=>{
        //     //TODO
        // });
        // robot.on('/docker_htop', (msg)=>{
        //     //TODO
        // });

        //connects socket.io, then runs handshake with the robot
        robot.connect();

        // socket.on('offer', (offer_data) => {
        //     console.log('Got webrtc offer:', offer_data)
        //     let id_robot = Object.keys(offer_data)[0];
        //     OnWebRTCOffer(id_robot, offer_data[id_robot]);
        // });

    });



</script>



<%- include('partial/footer.html'); %>
