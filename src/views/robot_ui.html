<%- include('partial/header.html', { extraLinks: [ '<a href="#" id="helpLink">?</a>' ] }); %>

<h1 id="robot_name">Waiting for Connection...</h1>
<div id="robot_info">Contacting <%= id_robot %>...</div>
<br>
<div id="robot_stats" style="display:none">

</div>

<div id="menubar">

    <div id="topic_controls">
        <h3 id="topics_heading">Topics</h3>
        <select id="msg_type_filter">
            <option value="">-- All message types --</option>
        </select>
        <div id="topic_list"></div>
    </div>

    <div id="service_controls">
        <h3 id="services_heading">Services</h3>
        <a href="#" id="services_gamepad_mapping_toggle">[shortcuts]</a>
        <div id="service_list"></div>
    </div>
</div>

<div class="grid-stack" id="grid-stack"></div>

<div id="monitors" style="display:none"></div>

<div id="gamepad">
    <div id="gamepad_status" title="Gamepad Settings"></div>
    <div id="gamepad_settings">
        <input type="checkbox" id="gamepad_enabled" checked="checked"/> <label for="gamepad_enabled">Transmitting</label>
        <div id="gamepad_debug"></div>
    </div>
</div>

<div id="mapping-confirmation"></div>

<script type="text/javascript">



    $(document ).ready(function() {

        let GridStack = window.exports.GridStack;

        grid = GridStack.init({
            cellHeight: 120,
        });

        // let items = [
        //     {x: 0, y: 0, w: 4, h: 2, content: '1 1 1 1 <br> 1 1 1 <br>'},
        //     {x: 4, y: 0, w: 4, h: 4, content: '2'},
        //     {x: 8, y: 0, w: 2, h: 2, content: '<p class="card-text text-center" style="margin-bottom: 0">Drag me!<p class="card-text text-center"style="margin-bottom: 0"><ion-icon name="hand" style="font-size: 300%"></ion-icon><p class="card-text text-center" style="margin-bottom: 0">'},
        //     {x: 10, y: 0, w: 2, h: 2, content: '4'},
        //     {x: 0, y: 2, w: 2, h: 2, content: '5'},
        //     {x: 2, y: 2, w: 2, h: 4, content: '6'},
        //     {x: 8, y: 2, w: 4, h: 2, content: '7'},
        //     {x: 0, y: 4, w: 2, h: 2, content: '8'},
        //     {x: 4, y: 4, w: 4, h: 2, content: '9'},
        //     {x: 8, y: 4, w: 2, h: 2, content: '10'},
        //     {x: 10, y: 4, w: 2, h: 2, content: '11'},
        // ];
        // grid.load(items);

        grid.on('added removed change', function(e, items) {

            if (items) {
                let str = '';
                items.forEach(function(item) { str += ' (x,y)=' + item.x + ',' + item.y; });
                console.warn('Grid: '+ e.type + ' ' + items.length + ' items:' + str );
            }

            UpdateUrlHash();
        });

        grid.on('resize', function(e, el) {
            let topic = $(el).find('.monitor_panel').attr('data-topic');
            console.warn('Grid resized: '+ topic);
            panels[topic].OnResize();
        });


        let msg_types_src = '/static/msg_types.json'
        fetch(msg_types_src)
            .then((response) => response.json())
            .then((json) => {
                supported_msg_types=json;
                console.log('Fetched '+json.length+' msg types from '+msg_types_src)

                let hash = window.location.hash;
                if (hash.length) {
                    hash = hash.substr(1);
                    let hashArr = hash.split(';');
                    for (let i = 0; i < hashArr.length; i++) {
                        let topic_vars = hashArr[i].trim();
                        if (!topic_vars)
                            continue;
                        topic_vars = topic_vars.split(':');
                        let topic = topic_vars[0];
                        let x = null; let y = null;
                        let panelPos = topic_vars[1];
                        if (panelPos) {
                            panelPos = panelPos.split('x');
                            x = panelPos[0];
                            y = panelPos[1];
                        }
                        let panelSize = topic_vars[2];
                        let w = 2; let h = 2;
                        if (panelSize) {
                            panelSize = panelSize.split('x');
                            w = panelSize[0];
                            h = panelSize[1];
                        }
                        let src_on = false;
                        for (let j = 2; j < topic_vars.length; j++) {
                            if (topic_vars[j] == 'src') {
                                src_on = true;
                            }
                        }

                        console.info('Opening panel for '+topic+'; src_on='+src_on);
                        TogglePanel(topic, true, w, h, x, y, src_on)
                    }
                }


                window.gamepadWriter = new GamepadWriter(pc, '/joy', '<%= id_robot %>', socket, supported_msg_types);

                //proceed when we have msg types ready
                socket.connect();
            });

        pc = InitPeerConnection('<%= id_robot %>');

        $('#msg_type_filter').change(()=>{
        let filter = $('#msg_type_filter').val();
        //console.log('msg_type_filter='+filter);

        let num_visible = 0;
        $('#topic_list DIV.topic').each(function() {
            console.log();
            if (filter == '' || $(this).data('msg_types').indexOf(filter) != -1) {
                $(this).css('display', 'block');
                num_visible++;
            }
            else {
                $(this).css('display', 'none');
            }
        });

        if (!num_visible)
            $('#topic_list_waiting').css('display', 'block').html('Waiting...');
        else
            $('#topic_list_waiting').css('display', 'none').empty();
        });

        // $('#topic_list INPUT:checkbox').change(()=>{
        //     let filter = $(this).val();
        //     //console.log('msg_type_filter='+filter);
        // })





        // client-side
        socket.on("connect", () => {
            console.log('SIO connected w id'+socket.id); // x8WIv7-mJelg7on_ALbx
            SetSocketIOSatusLabel();
            socket.emit('robot', { id: '<%= id_robot %>' },
                ProcessRobotData
            );
        });

        socket.on('robot', ProcessRobotData);

        socket.on('services', (services_data) => {
            $('#service_list').empty();
            //$('#service_list').css('display', 'block');

            console.log('Services:', services_data);

            services = {};

            let i = 0;
            Object.keys(services_data).forEach((id_robot) => {

                if (!services_data[id_robot])
                    return;

                let handled_services = [];
                let other_services = [];
                for (let i = 0; i < services_data[id_robot].length; i++) {
                    if (input_widgets[services_data[id_robot][i].msgType] != undefined)
                        handled_services.push(services_data[id_robot][i]);
                    else
                        other_services.push(services_data[id_robot][i]);
                }

                [ handled_services, other_services ].forEach((services_list)=>{

                    let handled = services_list == handled_services;

                    services_list.sort((a, b) => {
                        if (a.service < b.service) {
                            return -1;
                        }
                        if (a.service > b.service) {
                            return 1;
                        }
                        return 0;
                    });

                    services_list.forEach((service)=>{

                        services[service.service] = {
                            service: service.service,
                            msg_type: service.msgType,
                            n: i
                        }

                        $('#service_list').append('<div class="service '+(handled?'handled':'nonhandled')+'" data-service="'+service.service+'" data-msg_type="'+service.msgType+'">'
                            + '<div '
                            + 'class="service_heading" '
                            + 'title="'+service.msgType+'"'
                            + '>'
                            + service.service
                            + '</div>'
                            + '<div class="service_input_type" id="service_input_type'+i+'">' + service.msgType + '</div>'
                            + '<div class="service_input" id="service_input_'+i+'"></div>'
                            + '</div>'
                        );

                        if (input_widgets[service.msgType] != undefined) {
                            input_widgets[service.msgType]($('#service_input_'+i), services[service.service], '<%= id_robot %>', socket, supported_msg_types);
                        }

                        i++;

                    });

                });

                $('#services_heading').html(services_data[id_robot].length+' Services');
            });
        });


        socket.on('topics', (topics_data) => {
            $('#topic_list').empty();

            $('#robot_stats').css('display', 'block');
            //$('#topic_list').css('display', 'block');
            $('#monitors').css('display', 'block');

            let msg_type_filter_val = $('#msg_type_filter').val();
            $("#msg_type_filter option[value!='']").each(function() {
                $(this).remove();
            });

            console.log('Topics:', topics_data);

            let msg_type_filters = [];
            let old_topics = topics;
            topics = {};

            let i = 0;
            Object.keys(topics_data).forEach((id_robot) => {

                if (!topics_data[id_robot])
                    return;

                //sort by topic
                topics_data[id_robot].sort((a, b) => {
                    if (a.topic < b.topic) {
                        return -1;
                    }
                    if (a.topic > b.topic) {
                        return 1;
                    }
                    // a must be equal to b
                    return 0;
                });

                $('#topics_heading').html(topics_data[id_robot].length+' Topics');

                topics_data[id_robot].forEach((topic)=>{

                    topics[topic.topic] = {
                        msg_types: topic.msgTypes
                    }

                    $('#topic_list').append('<div class="topic" data-topic="'+topic.topic+'" data-msg_types="'+topic.msgTypes.join(',')+'">'
                        + '<input type="checkbox" id="cb_topic_'+i+'"'
                        //+ (!topic.robotTubscribed?' disabled':'')
                        + (panels[topic.topic] ? ' checked': '' )
                        + '/> '
                        + '<span '
                        + 'class="topic" '
                        + 'title="'+topic.msgTypes.join('; ')+'"'
                        + '>'
                        + '<label for="cb_topic_'+i+'" class="prevent-select">'+topic.topic+'</label>'
                        + '</span>'
                        + '</div>'
                    );

                    topic.msgTypes.forEach((msgType)=>{
                        if (msg_type_filters.indexOf(msgType) == -1)
                            msg_type_filters.push(msgType);
                    });

                    let subscribe = $('#cb_topic_'+i).is(':checked');

                    if (panels[topic.topic] && !panels[topic.topic].initialized) {
                        panels[topic.topic].Init(topic.msgTypes);
                        subscribe = true;
                    }

                    //if (!old_topics[topic.topic]) {

                    if (subscribe) {
                        //console.warn('New topic: '+topic.topic+'; subscribe='+subscribe);
                        ToggleReadTopicSubscription('<%= id_robot %>', topic.topic, true);
                    } else {
                        //console.info('New topic: '+topic.topic+'; subscribe='+subscribe);
                    }

                    //TogglePanel(topic.topic, true);
                    //}




                    i++;
                });
            });

            $('#topic_list').append('<div id="topic_list_waiting" style="display:none"></div>');

            if (msg_type_filter_val && msg_type_filters.indexOf(msg_type_filter_val) == -1) {
                msg_type_filters.push(msg_type_filter_val);
            }
            msg_type_filters.sort();
            msg_type_filters.forEach((msgType)=>{
                $("#msg_type_filter").append('<option value="'+msgType+'">'+msgType+'</option>');
            });
            $('#msg_type_filter').val(msg_type_filter_val).change();
            //console.log('topics reloaded, msg_type_filter_val='+msg_type_filter_val)

            $('#topic_list INPUT:checkbox').change(function(event) {
                let topic = $(this).parent('DIV.topic').data('topic');
                let state = this.checked;
                let w = 2; let h = 2;

                let msg_type = topics[topic].msg_types[0]

                if (panel_widgets[msg_type]) {
                    w = panel_widgets[msg_type].w;
                    h = panel_widgets[msg_type].h;
                }
                TogglePanel(topic, state, w, h);
                ToggleReadTopicSubscription('<%= id_robot %>', topic, state);
            });



        });


        $('#services_gamepad_mapping_toggle').click(function(event) {

            if (!$('#service_controls').hasClass('setting_shortcuts')) {
                $('#service_controls').addClass('setting_shortcuts');
                $('#services_gamepad_mapping_toggle').html('Press a button to map...');
            } else {
                $('#service_controls').removeClass('setting_shortcuts');
                $('#services_gamepad_mapping_toggle').html('[shortcuts]');
            }

            event.preventDefault();
        });

        // socket.on('offer', (offer_data) => {
        //     console.log('Got webrtc offer:', offer_data)
        //     let id_robot = Object.keys(offer_data)[0];
        //     OnWebRTCOffer(id_robot, offer_data[id_robot]);
        // });

        socket.on("disconnect", () => {
            console.log('SIO disconnected'); // undefined
            SetSocketIOSatusLabel();
        });


    });



</script>



<%- include('partial/footer.html'); %>